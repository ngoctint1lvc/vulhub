# Nginx file name logic vulnerability (CVE-2013-4547)

## Vulnerability description

Affected version: Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7

Reference link:

 - http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-4547
 - https://blog.werner.wiki/file-resolution-vulnerability-nginx/
 - http://www.91ri.org/9064.html

## Vulnerability description

This vulnerability actually has nothing to do with code execution. The main reason is that the requested URI is parsed incorrectly, and the file name requested by the user is incorrectly obtained, which leads to the collateral impact of permission bypass and code execution.

For example, for example, if Nginx matches to the end of .php, it will be sent to fastcgi for analysis. The common writing is as follows:

```
location ~ \.php$ {
    include fastcgi_params;

    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
    fastcgi_param DOCUMENT_ROOT /var/www/html;
}
```

Under normal circumstances (when pathinfo is turned off), only files with a .php suffix will be sent to fastcgi for analysis.

In the case of CVE-2013-4547, we request `1.gif[0x20][0x00].php`, this URI can match the regular `\.php$`, and you can enter this Location block; but after entering, Nginx mistakenly believes that the requested file is `1.gif[0x20]`, so it is set to the value of `SCRIPT_FILENAME` and sent to fastcgi.

Fastcgi parsed according to the value of `SCRIPT_FILENAME`, and finally caused a parsing vulnerability.

Therefore, we only need to upload a file ending with a space to make PHP parse it.

To give another example, for example, many websites restrict the IP that allows access to the background:

```
location /admin/ {
    allow 127.0.0.1;
    deny all;
}
```

We can request the following URI: `/test[0x20]/../admin/index.php`, this URI will not match the `/admin/` after the location, which bypasses the IP verification; but in the end The request is for the file `/test[0x20]/../admin/index.php`, which is `/admin/index.php`, successfully accessing the background. (The premise is that there needs to be a directory called `test`: this is a characteristic of the Linux system. If there is a directory that does not exist, even if you jump to the upper level, the file does not exist error. There is no such error in Windows limit)

## Vulnerability test

Start the vulnerability environment:

```
docker-compose build
docker-compose up -d
```

After the environment is started, visit `http://your-ip:8080/` to see an upload page.

This environment is blacklisted verification, we cannot upload files with php suffix, we need to use CVE-2013-4547. We upload a `1.gif`, pay attention to the following spaces:

![](01.png)

Visit `http://your-ip:8080/uploadfiles/1.gif[0x20][0x00].php`, you can find that PHP has been parsed:

![](02.png)

Note that [0x20] is a space and [0x00] is `\0`, neither of these two characters need to be encoded.